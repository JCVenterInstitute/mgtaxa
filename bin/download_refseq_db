#!/bin/bash
### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##
#
#   See COPYING file distributed along with the MGTAXA package for the
#   copyright and license terms.
#
### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##

set -ex

#[ -n "$MGT_NCBI_DB" ] || exit 1

this_script=$0

mkf_file=$(basename $this_script).mkf

#dbdir=$MGT_NCBI_DB/refseq
dbdir=$(pwd)
dldir=$dbdir/dl

mkdir -p $dbdir
mkdir -p $dldir

topUrl=ftp://ftp.ncbi.nlm.nih.gov/refseq/release

orgGroups="viral"
#orgGroups="microbial protozoa viral"
#orgGroups="microbial protozoa viral fungi invertebrate plant vertebrate_mammalian vertebrate_other"

# set to something to just download FASTA files and w/o processing
onlyFna=

name="$1"

if [ -z "$name" ]; then

    echo > $mkf_file

    for name in $orgGroups; do
        echo "$name.flag.ok: $mkf_file" >> $mkf_file
        echo "    $this_script $name"   >> $mkf_file
    done
    #makeflow -T sge -B '-P 9223 -b n -S /bin/bash' $mkf_file
    makeflow -j 1 $mkf_file

else

    rm -f $name.flag.ok

    if [ -z "$onlyFna" ]; then
        pushd $dldir
        wget -v "${topUrl}/${name}/${name}[.0-9]*.{genomic,protein}.*.gz"
        touch ${name}* # wget keeps timestamps from download side
        for suff in genomic.fna genomic.gbff protein.faa protein.gpff; do
            gunzip -c ${name}*.${suff}.gz > ${dbdir}/${name}.${suff}
            touch $dbdir/${name}*
        done
        popd
        for gbFile in ${dbdir}/${name}.[gp]*.g?ff; do
            python $MGT_HOME/bin/extractGbHeader.py < $gbFile > $gbFile.hdr
            gzip $gbFile
            gzip $gbFile.hdr
        done
        for faFile in ${dbdir}/${name}.[gp]*.f?a; do
            grep '>' $faFile > $faFile.hdr
            gzip $faFile
        done
    else
        pushd $dbdir
        wget -v "${topUrl}/${name}/${name}[.0-9]*.[g]*.fna.gz"
        touch ${name}* # wget keeps timestamps from download side
        popd
    fi
    
    echo "ok" > $name.flag.ok
fi

