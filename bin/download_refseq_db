#!/bin/bash
### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##
#
#   See COPYING file distributed along with the MGTAXA package for the
#   copyright and license terms.
#
### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##

set -ex

[ -n "$MGT_NCBI_DB" ] || exit 1

dbdir=$MGT_NCBI_DB/refseq
dldir=$dbdir/dl

mkdir -p $dbdir
mkdir -p $dldir

topUrl=ftp://ftp.ncbi.nlm.nih.gov/refseq/release

#orgGroups="microbial protozoa viral"
orgGroups="fungi invertebrate plant vertebrate_mammalian vertebrate_other"

onlyFna=1

for name in $orgGroups; do
    if [ -z "$onlyFna" ]; then
        cd $dldir
        wget -v "${topUrl}/${name}/${name}[.0-9]*.[gp]*.*.gz"
        touch * # wget keeps timestamps from download side
        for suff in genomic.fna genomic.gbff protein.faa protein.gpff; do
            gunzip -c ${name}*.${suff}.gz > ${dbdir}/${name}.${suff}
            touch $dbdir/*
        done
        for gbFile in ${dbdir}/${name}.[gp]*.g?ff; do
            python $MGT_HOME/bin/extractGbHeader.py < $gbFile > $gbFile.hdr
            gzip $gbFile
            gzip $gbFile.hdr
        done
        for faFile in ${dbdir}/${name}.[gp]*.f?a; do
            grep '>' $faFile > $faFile.hdr
            gzip $faFile
        done
    else
        cd $dbdir
        wget -v "${topUrl}/${name}/${name}[.0-9]*.[g]*.fna.gz"
        touch * # wget keeps timestamps from download side
    fi
done

