#!/bin/bash
# Script to finish deployment
# Run on the target deployment host after the directory trees have been updated

set -ex

DEPLOY_ROLES=$1
if [ -z "$DEPLOY_ROLES" ]; then
    echo "usage: $(basename $0) <frontend|backend>"
    exit 1
fi

MGT_SRC=~/work/mgtaxa

GPM_SRC=~/work/gridway-proxy-mad/src

pushd $MGT_SRC
rm -rf build
mkdir build
cd build
make -f ../Makefile install

popd

pushd $GPM_SRC

GPM_EXTRA_CONF_FILE=auto_deploy_loc.conf.tmp

######### HERE DOC FOR GPM CONFIG ##########
cat > $GPM_EXTRA_CONF_FILE  <<End-of-message

# This config was autogenerated by $(basename $0) 
# on $(date)
# It will be re-created the next time that tool runs.

[install_gpm]

deploy_roles=$DEPLOY_ROLES
                  
frontend_host=mgtaxa
frontend_username=mgtaxa
frontend_gridway_dir=/home/mgtaxa/work/packages/x86_64-rhel5/gridway
                              
backend_host=mgtaxa-app
backend_username=mgtaxa
backend_data_dir_prefix=/usr/local/projects/MGTAXA/scratch/mgtaxa/backend

code_location_backend = /local/projects5/MGTAXA/mgtaxa/packages/x86_64-rhel5/mgtaxa-galaxy
code_location_frontend = /opt/software/mgtaxa/work/packages/x86_64-rhel5/mgtaxa-galaxy

End-of-message

######## END HERE DOC FOR GPM CONFIG #########

GPM_EXTRA_CONF_FILE=$GPM_EXTRA_CONF_FILE python setup.py build install --prefix=$INSTMACH

popd

/etc/init.d/mgtaxa restart

