#!/bin/bash
## Sample script to finish deployment from devepment host to production.
## Run on the target deployment hosts (internal application host and dmz front) 
## after the directory trees have been updated with deploy_copy script.
## @todo on DMZ, the make_readable call somehow make the whole script
## to exit. Make sure that you run what is after it manually when needed.

set -ex

DEPLOY_ROLES=$1
if [ -z "$DEPLOY_ROLES" ]; then
    echo "usage: $(basename $0) <frontend|backend>"
    exit 1
fi

[ -n "$PRIV_DATA" ] || exit 1

MGT_SRC=~/work/mgtaxa

GPM_SRC=~/work/gridway-proxy-mad/src

source $MGT_SRC/deps/config/functions.sh

pushd $MGT_SRC
rm -rf build
mkdir build
cd build
make -f ../Makefile install

popd

pushd $GPM_SRC

rm -rf build

GPM_EXTRA_CONF_FILE=auto_deploy_loc.conf.tmp

######### HERE DOC FOR GPM CONFIG ##########
cat > $GPM_EXTRA_CONF_FILE  <<End-of-message

# This config was autogenerated by $(basename $0) 
# on $(date)
# It will be re-created the next time that tool runs.

[install_gpm]

deploy_roles=$DEPLOY_ROLES
                  
frontend_host=mgtaxa
frontend_username=mgtaxa
frontend_gridway_dir=/home/mgtaxa/work/packages/x86_64-rhel6/gridway
                              
backend_host=mgtaxa-app
backend_username=mgtaxa
backend_data_dir_prefix=/usr/local/scratch/METAGENOMICS/mgtaxa/web

code_location_backend = /local/MGTAXA/mgtaxa/packages/x86_64-rhel6/mgtaxa-galaxy
code_location_frontend = /opt/software/mgtaxa/work/packages/x86_64-rhel6/mgtaxa-galaxy

backend_var_dir=/home/mgtaxa/work/packages/var

End-of-message

######## END HERE DOC FOR GPM CONFIG #########

if [[ "$DEPLOY_ROLES" == "backend" ]]; then
    [ -e $PRIV_DATA/gpm_mysql ] && (cat $PRIV_DATA/gpm_mysql >> $GPM_EXTRA_CONF_FILE)
fi

GPM_EXTRA_CONF_FILE=$GPM_EXTRA_CONF_FILE python setup.py build install --prefix=$INSTMACH

popd

if [[ "$DEPLOY_ROLES" == "frontend" ]]; then
    # Apache user will need to serve static content from Galaxy directory
    make_readable $GALAXY_LOCATION/static
fi

$MGT_SRC/deps/mgt_control_services $DEPLOY_ROLES restart

